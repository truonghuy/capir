<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>UnityCAPIR: /Users/truonghuy/Research/amdp/UnityCAPIR/UnityCAPIR/Assets/Scripts/PrefabScripts/CapirBox.cs Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="sheep-icon-normal.png"></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">UnityCAPIR&#160;<span id="projectnumber">1.0</span></div>
   <div id="projectbrief">API documentation of UnityCAPIR</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('_capir_box_8cs.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>/Users/truonghuy/Research/amdp/UnityCAPIR/UnityCAPIR/Assets/Scripts/PrefabScripts/CapirBox.cs</h1>  </div>
</div>
<div class="contents">
<a href="_capir_box_8cs.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="keyword">using</span> UnityEngine;
<a name="l00002"></a>00002 <span class="keyword">using</span> System.Collections;
<a name="l00003"></a>00003 <span class="keyword">using</span> System.Collections.Generic;
<a name="l00004"></a>00004 <span class="keyword">using</span> System.IO;
<a name="l00005"></a>00005 <span class="keyword">using</span> System.Diagnostics;
<a name="l00006"></a>00006 <span class="keyword">using</span> System;
<a name="l00007"></a>00007 
<a name="l00009"></a>00009 <span class="keyword">using</span> System.Xml;
<a name="l00010"></a>00010 <span class="keyword">using</span> System.Text;
<a name="l00011"></a>00011 
<a name="l00019"></a><a class="code" href="class_capir_box.html">00019</a> <span class="keyword">public</span> <span class="keyword">class </span><a class="code" href="class_capir_box.html" title="The CAPIR object for action query.">CapirBox</a> {
<a name="l00020"></a>00020  
<a name="l00021"></a>00021  <span class="comment">// npcTypes can be retrieved at caller.levelData.initConfig.mazeProperties</span>
<a name="l00022"></a>00022  <span class="comment">//public int[] npcTypes;</span>
<a name="l00023"></a>00023  
<a name="l00027"></a><a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07">00027</a>  <span class="keyword">private</span> <a class="code" href="class_main_c_sharp.html" title="The main game script.">MainCSharp</a> <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>; 
<a name="l00031"></a><a class="code" href="class_capir_box.html#aa730c780f4f5972e3e4bb4475b5e770f">00031</a>  <span class="keyword">private</span> <a class="code" href="class_agent_script.html" title="Control script of the human-controlled character.">AgentScript</a> <a class="code" href="class_capir_box.html#aa730c780f4f5972e3e4bb4475b5e770f" title="The human-controlled character.">agent</a>;
<a name="l00032"></a>00032  
<a name="l00041"></a><a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a">00041</a>  <span class="keyword">private</span> <span class="keywordtype">int</span>[] <a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>;
<a name="l00042"></a>00042  
<a name="l00046"></a><a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb">00046</a>  <span class="keyword">private</span> List&lt;int&gt; <a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>; 
<a name="l00047"></a>00047  
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="class_capir_box.html#ac75212f782182be095c00d7be9a8e613">00061</a>  <span class="keyword">public</span> List&lt;double[,,]&gt; <a class="code" href="class_capir_box.html#ac75212f782182be095c00d7be9a8e613" title="Stores the Q values of the NPC types existing in the map.">QValues</a>;
<a name="l00062"></a>00062  <span class="comment">//public List&lt;Dictionary&lt;VirtualState, int&gt; &gt; StateMaps;</span>
<a name="l00063"></a>00063  
<a name="l00064"></a>00064  <span class="comment">/* For belief update and action selection */</span>
<a name="l00065"></a>00065  
<a name="l00069"></a><a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c">00069</a>  <span class="keyword">private</span> <span class="keywordtype">double</span>[] <a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c" title="The belief on human&amp;#39;s intention.">belief</a>;
<a name="l00070"></a>00070  
<a name="l00077"></a><a class="code" href="class_capir_box.html#a04cfc66fb085d1742c5e83a1fd6f4692">00077</a>  <span class="keyword">private</span> <span class="keywordtype">double</span> <a class="code" href="class_capir_box.html#a04cfc66fb085d1742c5e83a1fd6f4692" title="The preset human persistence.">agentPersistence</a>;
<a name="l00078"></a>00078  
<a name="l00085"></a><a class="code" href="class_capir_box.html#a9aa26f53dbfb0d2a5a307ddd31fec702">00085</a>  <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code" href="class_capir_box.html#a9aa26f53dbfb0d2a5a307ddd31fec702" title="Gets or sets the helper action.">helperAction</a> {<span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>;}
<a name="l00086"></a>00086  
<a name="l00088"></a>00088  <span class="comment">//public static Stopwatch stopWatch;</span>
<a name="l00089"></a>00089  
<a name="l00090"></a>00090  <span class="comment">/*************** Functions ***********************/</span>
<a name="l00091"></a>00091  
<a name="l00098"></a><a class="code" href="class_capir_box.html#aa9b8908d4e418f846a435409b9804d41">00098</a>  <span class="keyword">public</span> <a class="code" href="class_capir_box.html#aa9b8908d4e418f846a435409b9804d41" title="Initializes a new instance of the CapirBox class.">CapirBox</a>(<a class="code" href="class_main_c_sharp.html" title="The main game script.">MainCSharp</a> caller){
<a name="l00099"></a>00099   <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a> = caller;
<a name="l00100"></a>00100   <a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a> = <span class="keyword">new</span> <span class="keywordtype">int</span>[<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a9aaf83d7e529d3721f41e2c0d5b9ca3e">NumNPCTypes</a>];
<a name="l00101"></a>00101   <span class="comment">// initialize to existingNPCTypes</span>
<a name="l00102"></a>00102   <a class="code" href="class_utilities.html" title="Utilities class that has utility routines.">Utilities</a>.Populate&lt;<span class="keywordtype">int</span>&gt;(<a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>, -1); 
<a name="l00103"></a>00103   
<a name="l00104"></a>00104   <a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a> = <span class="keyword">new</span> List&lt;int&gt;();
<a name="l00105"></a>00105   
<a name="l00106"></a>00106   <a class="code" href="class_capir_box.html#ac75212f782182be095c00d7be9a8e613" title="Stores the Q values of the NPC types existing in the map.">QValues</a> = <span class="keyword">new</span> List&lt;double[,,]&gt;(); <span class="comment">// new List&lt;List&lt;List&lt;double&gt;&gt;&gt;();</span>
<a name="l00107"></a>00107   <span class="comment">//StateMaps = new List&lt;Dictionary&lt;VirtualState, int&gt;&gt;();</span>
<a name="l00108"></a>00108   
<a name="l00109"></a>00109   <span class="comment">//stopWatch = new Stopwatch();</span>
<a name="l00110"></a>00110  }
<a name="l00111"></a>00111  
<a name="l00118"></a><a class="code" href="class_capir_box.html#abc2f8e9735f6cfcdc067d463ca0bb729">00118</a>  <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_capir_box.html#abc2f8e9735f6cfcdc067d463ca0bb729" title="Start this instance.">Start</a>(){
<a name="l00119"></a>00119   <a class="code" href="class_capir_box.html#a04cfc66fb085d1742c5e83a1fd6f4692" title="The preset human persistence.">agentPersistence</a> = <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a7ccd40cb1491a52181da42c6767775cf" title="The GameObject to represent AI-controlled character.">helperCube</a>.GetComponent&lt;<a class="code" href="class_helper_script.html" title="This class defines the behavior of the helper.">HelperScript</a>&gt;().<a class="code" href="class_capir_box.html#a04cfc66fb085d1742c5e83a1fd6f4692" title="The preset human persistence.">agentPersistence</a>;
<a name="l00120"></a>00120   <a class="code" href="class_capir_box.html#aa730c780f4f5972e3e4bb4475b5e770f" title="The human-controlled character.">agent</a> = <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#aaabcd7df9e88111731f6a9b5e377412a" title="The GameObject to represent human-controlled character.">agentCube</a>.GetComponent&lt;<a class="code" href="class_agent_script.html" title="Control script of the human-controlled character.">AgentScript</a>&gt;();
<a name="l00121"></a>00121  }
<a name="l00122"></a>00122  
<a name="l00126"></a><a class="code" href="class_capir_box.html#a089747b59ec4a16181150301ecf24ddf">00126</a>  <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_capir_box.html#a089747b59ec4a16181150301ecf24ddf" title="Clear this instance: clear npcTypes, QValues and existingNPCTypes.">clear</a>(){
<a name="l00127"></a>00127   <a class="code" href="class_utilities.html" title="Utilities class that has utility routines.">Utilities</a>.Populate&lt;<span class="keywordtype">int</span>&gt;(<a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>, -1);
<a name="l00128"></a>00128   <a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>.Clear();
<a name="l00129"></a>00129   <a class="code" href="class_capir_box.html#ac75212f782182be095c00d7be9a8e613" title="Stores the Q values of the NPC types existing in the map.">QValues</a>.Clear();
<a name="l00130"></a>00130  }
<a name="l00131"></a>00131  
<a name="l00135"></a><a class="code" href="class_capir_box.html#a34b878b7e4f16a188cf42109c109c573">00135</a>  <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_capir_box.html#a34b878b7e4f16a188cf42109c109c573" title="Restart this instance: initialize belief to uniform distribution.">restart</a>(){
<a name="l00136"></a>00136   <a class="code" href="class_utilities.html" title="Utilities class that has utility routines.">Utilities</a>.Populate&lt;<span class="keywordtype">double</span>&gt;(<a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c" title="The belief on human&amp;#39;s intention.">belief</a>, 1 / (double)<a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>.Count);
<a name="l00137"></a>00137  }
<a name="l00138"></a>00138  
<a name="l00145"></a><a class="code" href="class_capir_box.html#a0bed09e886ab0581c98e5e68c1473695">00145</a>  <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_capir_box.html#a0bed09e886ab0581c98e5e68c1473695" title="Reads the tmx file. Use this for initialization.">readTmxFile</a>(<span class="keywordtype">string</span> filename){
<a name="l00146"></a>00146   
<a name="l00147"></a>00147   XmlDocument root = <span class="keyword">new</span> XmlDocument();
<a name="l00148"></a>00148   <span class="keywordtype">string</span> fullFilename = Path.Combine( Application.dataPath, <span class="stringliteral">&quot;Resources/&quot;</span>+filename);
<a name="l00149"></a>00149   <span class="comment">//string fullFilename = Path.Combine( Application.dataPath, &quot;Resources/test_level.tmx&quot;);</span>
<a name="l00150"></a>00150   root.Load(fullFilename);
<a name="l00151"></a>00151   
<a name="l00152"></a>00152   XmlNodeList layers = root.GetElementsByTagName(<span class="stringliteral">&quot;layer&quot;</span>);
<a name="l00153"></a>00153   
<a name="l00154"></a>00154   <span class="comment">// there&#39;s actually only 1 layer, ie. layers.Count = 1.</span>
<a name="l00155"></a>00155   <span class="keywordtype">int</span> xSize = <span class="keywordtype">int</span>.Parse(layers[0].Attributes[<span class="stringliteral">&quot;width&quot;</span>].Value);
<a name="l00156"></a>00156   <span class="keywordtype">int</span> ySize = <span class="keywordtype">int</span>.Parse(layers[0].Attributes[<span class="stringliteral">&quot;height&quot;</span>].Value);
<a name="l00157"></a>00157   
<a name="l00158"></a>00158   XmlNodeList tileSetNodes = root.SelectNodes(<span class="stringliteral">&quot;/map/tileset/tile&quot;</span>); <span class="comment">// root.GetElementsByTagName(&quot;tileset&quot;);</span>
<a name="l00159"></a>00159   <span class="comment">//Debug.Log(&quot;number of elements in tileSetNodes = &quot; + tileSetNodes.Count);</span>
<a name="l00160"></a>00160   XmlNode propNode;
<a name="l00161"></a>00161   
<a name="l00162"></a>00162   <span class="comment">// 1. Properties</span>
<a name="l00163"></a>00163   <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a02ba8220f4a4b6e1851f2722e10e27fd" title="Gets or sets the ghost vision limit.">ghostVisLim</a> = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a7ce89dbb8c73e21594111f6b605862b6" title="Default distance within which NPCs &amp;quot;see&amp;quot; the players.">DefaultVisibility</a>;
<a name="l00164"></a>00164   <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a2ee0f3f47540ecd4b7ac9660b29a8dbd" title="Gets or sets the Sheep vision limit.">sheepVisLim</a> = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a7ce89dbb8c73e21594111f6b605862b6" title="Default distance within which NPCs &amp;quot;see&amp;quot; the players.">DefaultVisibility</a>;
<a name="l00165"></a>00165   <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#ae107248dee54bf942316b382f164fff2" title="Gets or sets the Fiery vision limit.">fieryVisLim</a> = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a7ce89dbb8c73e21594111f6b605862b6" title="Default distance within which NPCs &amp;quot;see&amp;quot; the players.">DefaultVisibility</a>;
<a name="l00166"></a>00166   
<a name="l00167"></a>00167   <span class="comment">// 2. Ghost properties</span>
<a name="l00168"></a>00168   <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af428bbb428c8822bdb298608240c4149" title="Gets or sets the ghost max HP.">ghostMaxHP</a> = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a4b64e04c55c4bf868a9acef5c5b149dd" title="Default hit points of Ghost.">DefaultGhostHP</a>;
<a name="l00169"></a>00169   <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#afa6d3b6bc1f48bd8babeb9c6b451ec3d" title="Gets or sets the ghost shot distance, within which the human-controlled character can shoot the ghost...">ghostShotDistance</a> = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a23ae2653e777a0ae6ca98b1f6ae6baab" title="Default distance within which the human-controlled character can shoot ghosts.">DefaultGhostShotDist</a>;
<a name="l00170"></a>00170   
<a name="l00171"></a>00171   <span class="keywordflow">foreach</span>(XmlNode tileNode <span class="keywordflow">in</span> tileSetNodes){
<a name="l00172"></a>00172    
<a name="l00173"></a>00173    <span class="comment">// visionLimit applies for all NPCs</span>
<a name="l00174"></a>00174    propNode = tileNode.SelectSingleNode(<span class="stringliteral">&quot;properties/property[@name=&#39;visionLimit&#39;]&quot;</span>);
<a name="l00175"></a>00175    
<a name="l00176"></a>00176    <span class="keywordflow">if</span> (propNode != null){
<a name="l00177"></a>00177     <span class="keywordflow">switch</span> (<span class="keywordtype">int</span>.Parse(tileNode.Attributes[<span class="stringliteral">&quot;id&quot;</span>].Value)){
<a name="l00178"></a>00178     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a19506f880a36ff4be873b065cd4e52c7">GB_GhostTileId</a>:
<a name="l00179"></a>00179      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a02ba8220f4a4b6e1851f2722e10e27fd" title="Gets or sets the ghost vision limit.">ghostVisLim</a> = <span class="keywordtype">int</span>.Parse(propNode.Attributes[<span class="stringliteral">&quot;value&quot;</span>].Value);
<a name="l00180"></a>00180      <span class="keywordflow">break</span>;
<a name="l00181"></a>00181     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a6e7e1d05dfabc85ed14fac18b7d37612">GB_SheepDeterministicTileId</a>:
<a name="l00182"></a>00182      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a2ee0f3f47540ecd4b7ac9660b29a8dbd" title="Gets or sets the Sheep vision limit.">sheepVisLim</a> = <span class="keywordtype">int</span>.Parse(propNode.Attributes[<span class="stringliteral">&quot;value&quot;</span>].Value);
<a name="l00183"></a>00183      <span class="keywordflow">break</span>;
<a name="l00184"></a>00184     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a66afbc1a36e623b9a01c9633ba7d0d38">GB_FieryTileId</a>:
<a name="l00185"></a>00185      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#ae107248dee54bf942316b382f164fff2" title="Gets or sets the Fiery vision limit.">fieryVisLim</a> = <span class="keywordtype">int</span>.Parse(propNode.Attributes[<span class="stringliteral">&quot;value&quot;</span>].Value);
<a name="l00186"></a>00186      <span class="keywordflow">break</span>;
<a name="l00187"></a>00187     }
<a name="l00188"></a>00188    }
<a name="l00189"></a>00189    
<a name="l00190"></a>00190    <span class="comment">// For ghosts</span>
<a name="l00191"></a>00191    propNode = tileNode.SelectSingleNode(<span class="stringliteral">&quot;properties/property[@name=&#39;shotDistance&#39;]&quot;</span>);
<a name="l00192"></a>00192    <span class="keywordflow">if</span> (propNode != null &amp;&amp; 
<a name="l00193"></a>00193     <span class="keywordtype">int</span>.Parse(tileNode.Attributes[<span class="stringliteral">&quot;id&quot;</span>].Value) == <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a19506f880a36ff4be873b065cd4e52c7">GB_GhostTileId</a>)
<a name="l00194"></a>00194    {
<a name="l00195"></a>00195     <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#afa6d3b6bc1f48bd8babeb9c6b451ec3d" title="Gets or sets the ghost shot distance, within which the human-controlled character can shoot the ghost...">ghostShotDistance</a> = <span class="keywordtype">int</span>.Parse(propNode.Attributes[<span class="stringliteral">&quot;value&quot;</span>].Value);
<a name="l00196"></a>00196    }
<a name="l00197"></a>00197    
<a name="l00198"></a>00198    propNode = tileNode.SelectSingleNode(<span class="stringliteral">&quot;properties/property[@name=&#39;maxHP&#39;]&quot;</span>);
<a name="l00199"></a>00199    <span class="keywordflow">if</span> (propNode != null &amp;&amp; 
<a name="l00200"></a>00200     <span class="keywordtype">int</span>.Parse(tileNode.Attributes[<span class="stringliteral">&quot;id&quot;</span>].Value) == <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a19506f880a36ff4be873b065cd4e52c7">GB_GhostTileId</a>)
<a name="l00201"></a>00201    {
<a name="l00202"></a>00202     <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af428bbb428c8822bdb298608240c4149" title="Gets or sets the ghost max HP.">ghostMaxHP</a> = <span class="keywordtype">int</span>.Parse(propNode.Attributes[<span class="stringliteral">&quot;value&quot;</span>].Value);
<a name="l00203"></a>00203    }
<a name="l00204"></a>00204   }
<a name="l00205"></a>00205   
<a name="l00206"></a>00206   XmlNodeList tiles = root.SelectNodes(<span class="stringliteral">&quot;/map/layer/data/tile&quot;</span>);
<a name="l00207"></a>00207   <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a> = <span class="keyword">new</span> <a class="code" href="class_map_data.html" title="This class represents the level&amp;#39;s map and initial state.">MapData</a>(xSize, ySize);
<a name="l00208"></a>00208   
<a name="l00209"></a>00209   <span class="keywordtype">int</span> tileIndex = 0;
<a name="l00210"></a>00210   <span class="keywordtype">bool</span> gotSheep = <span class="keyword">false</span>, gotGhost = <span class="keyword">false</span>, gotFiery = <span class="keyword">false</span>;
<a name="l00211"></a>00211   
<a name="l00212"></a>00212   <span class="comment">// QIndex keeps track of which Q-values belong to which npc type</span>
<a name="l00213"></a>00213   <span class="keywordtype">int</span> QIndex = 0;
<a name="l00214"></a>00214   
<a name="l00215"></a>00215   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; ySize; i++) {
<a name="l00216"></a>00216    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; xSize; j++) {
<a name="l00217"></a>00217     <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a4b208d1f9c0aa26723036d75058035be" title="The map layout.">map</a>[j, ySize - i - 1] = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a19e5d0802ad106d4c8c9424809fe8ffc">Ground</a>;
<a name="l00218"></a>00218     
<a name="l00219"></a>00219     <span class="keywordflow">switch</span>(<span class="keywordtype">int</span>.Parse(tiles[tileIndex].Attributes[<span class="stringliteral">&quot;gid&quot;</span>].Value)){
<a name="l00220"></a>00220     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#ac69afa91680c21c32cbee18b016081ca">GB_WallId</a>:
<a name="l00221"></a>00221      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a4b208d1f9c0aa26723036d75058035be" title="The map layout.">map</a>[j, ySize - i - 1] = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a4a6e415e1dedf46c975c51527f6c76ba">Wall</a>;
<a name="l00222"></a>00222      <span class="keywordflow">break</span>;
<a name="l00223"></a>00223     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a1f9ec3c4c2467052a46be30e1e63acf7">GB_FieryExitTileId</a>:
<a name="l00224"></a>00224      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a4b208d1f9c0aa26723036d75058035be" title="The map layout.">map</a>[j, ySize - i - 1] = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a6903974cd2c6a54a724034848c799ef8">FieryExit</a>;
<a name="l00225"></a>00225      <span class="keywordflow">break</span>;
<a name="l00226"></a>00226     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a367f1dc9c03b5886d3d5f0ef8186190a">GB_FieryPenTileId</a>:
<a name="l00227"></a>00227      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a4b208d1f9c0aa26723036d75058035be" title="The map layout.">map</a>[j, ySize - i - 1] = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#aad007b44a4bcd7246d3c35822b3e2a1e">FieryPen</a>;
<a name="l00228"></a>00228      <span class="keywordflow">break</span>;
<a name="l00229"></a>00229     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a91cfa807ac226a846dba00d3d92d0a37">GB_SheepDeterministicPenTileId</a>:
<a name="l00230"></a>00230      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a4b208d1f9c0aa26723036d75058035be" title="The map layout.">map</a>[j, ySize - i - 1] = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a9d322a4981c13708bd22c5e4e7471a82">SheepPen</a>;
<a name="l00231"></a>00231      <span class="keywordflow">break</span>;
<a name="l00232"></a>00232     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a0561e75fc9be0b8897013e336a007d71">GB_HumanTileId</a>:
<a name="l00233"></a>00233      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#aeec30c5399a9d0e07410801988c7b1e7" title="The initial state.">initConfig</a>.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[0,0] = j;
<a name="l00234"></a>00234      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#aeec30c5399a9d0e07410801988c7b1e7" title="The initial state.">initConfig</a>.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[0,1] = ySize - i - 1;
<a name="l00235"></a>00235      <span class="keywordflow">break</span>;
<a name="l00236"></a>00236     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a5d9357bbfc295bc6c38cc74f8a0acd4d">GB_AssistantTileId</a>:
<a name="l00237"></a>00237      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#aeec30c5399a9d0e07410801988c7b1e7" title="The initial state.">initConfig</a>.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,0] = j;
<a name="l00238"></a>00238      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#aeec30c5399a9d0e07410801988c7b1e7" title="The initial state.">initConfig</a>.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,1] = ySize - i - 1;
<a name="l00239"></a>00239      <span class="keywordflow">break</span>;
<a name="l00240"></a>00240     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a19506f880a36ff4be873b065cd4e52c7">GB_GhostTileId</a>:
<a name="l00241"></a>00241      <span class="comment">// ghost by default has 3 hit points</span>
<a name="l00242"></a>00242      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#aeec30c5399a9d0e07410801988c7b1e7" title="The initial state.">initConfig</a>.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>.Add(<span class="keyword">new</span> List&lt;int&gt;(){<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a9adae103b4e7ce4675e033f07efdff5d">GhostType</a>, 
<a name="l00243"></a>00243       j, ySize - i - 1, <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af428bbb428c8822bdb298608240c4149" title="Gets or sets the ghost max HP.">ghostMaxHP</a>});
<a name="l00244"></a>00244      <a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>.Add(<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a9adae103b4e7ce4675e033f07efdff5d">GhostType</a>);
<a name="l00245"></a>00245      <span class="keywordflow">if</span> (!gotGhost){
<a name="l00246"></a>00246       gotGhost = <span class="keyword">true</span>;
<a name="l00247"></a>00247       <a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>[<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a9adae103b4e7ce4675e033f07efdff5d">GhostType</a>] = QIndex;
<a name="l00248"></a>00248       <span class="comment">//readQMap(fullFilename + &quot;.&quot;+GameConstants.GhostTypeStr);</span>
<a name="l00249"></a>00249       QIndex++;
<a name="l00250"></a>00250      }
<a name="l00251"></a>00251      <span class="keywordflow">break</span>;
<a name="l00252"></a>00252     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a6e7e1d05dfabc85ed14fac18b7d37612">GB_SheepDeterministicTileId</a>:
<a name="l00253"></a>00253      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#aeec30c5399a9d0e07410801988c7b1e7" title="The initial state.">initConfig</a>.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>.Add(<span class="keyword">new</span> List&lt;int&gt;(){<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a8f005189ec74840e59de18ffb99fa2ac">SheepType</a>, 
<a name="l00254"></a>00254       j, ySize - i - 1});
<a name="l00255"></a>00255      <a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>.Add(<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a8f005189ec74840e59de18ffb99fa2ac">SheepType</a>);
<a name="l00256"></a>00256      <span class="keywordflow">if</span> (!gotSheep){
<a name="l00257"></a>00257       gotSheep = <span class="keyword">true</span>;
<a name="l00258"></a>00258       <a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>[<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a8f005189ec74840e59de18ffb99fa2ac">SheepType</a>] = QIndex;
<a name="l00259"></a>00259       <span class="comment">//readQMap(fullFilename + &quot;.&quot;+GameConstants.SheepTypeStr);</span>
<a name="l00260"></a>00260       QIndex++;
<a name="l00261"></a>00261      }
<a name="l00262"></a>00262      <span class="keywordflow">break</span>;
<a name="l00263"></a>00263     <span class="keywordflow">case</span> <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a66afbc1a36e623b9a01c9633ba7d0d38">GB_FieryTileId</a>:
<a name="l00264"></a>00264      <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#aeec30c5399a9d0e07410801988c7b1e7" title="The initial state.">initConfig</a>.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>.Add(<span class="keyword">new</span> List&lt;int&gt;(){<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a5f650facea7d8eb6cb1a62286d19ebf0">FieryType</a>, 
<a name="l00265"></a>00265       j, ySize - i - 1});
<a name="l00266"></a>00266      <a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>.Add(<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a5f650facea7d8eb6cb1a62286d19ebf0">FieryType</a>);
<a name="l00267"></a>00267      <span class="keywordflow">if</span> (!gotFiery){
<a name="l00268"></a>00268       gotFiery = <span class="keyword">true</span>;
<a name="l00269"></a>00269       <a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>[<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a5f650facea7d8eb6cb1a62286d19ebf0">FieryType</a>] = QIndex;
<a name="l00270"></a>00270       <span class="comment">//readQMap(fullFilename + &quot;.&quot;+GameConstants.FieryTypeStr);</span>
<a name="l00271"></a>00271       QIndex++;
<a name="l00272"></a>00272      }     
<a name="l00273"></a>00273      <span class="keywordflow">break</span>;
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275     tileIndex++;
<a name="l00276"></a>00276    }
<a name="l00277"></a>00277   }
<a name="l00278"></a>00278   
<a name="l00279"></a>00279   <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#aea90bf59f9b0c1010e8cea279d5219d6" title="Calculates the shortest path matrix.">calcShortestPathMatrix</a>();
<a name="l00280"></a>00280   
<a name="l00281"></a>00281   <span class="comment">// construct state map and read Q functions</span>
<a name="l00282"></a>00282   
<a name="l00283"></a>00283   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt; <a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>.Count; i++){
<a name="l00284"></a>00284    <span class="keywordflow">if</span> (<a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>[<a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>[i]] &gt;= <a class="code" href="class_capir_box.html#ac75212f782182be095c00d7be9a8e613" title="Stores the Q values of the NPC types existing in the map.">QValues</a>.Count){
<a name="l00285"></a>00285     <a class="code" href="class_capir_box.html#acf9795ec4895ceddd340b3a2658fb1b6" title="Reads the Q map.">readQMap</a>(fullFilename, <a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>[i]);
<a name="l00286"></a>00286    }
<a name="l00287"></a>00287   } 
<a name="l00288"></a>00288   
<a name="l00289"></a>00289   <span class="comment">// init belief</span>
<a name="l00290"></a>00290   <a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c" title="The belief on human&amp;#39;s intention.">belief</a> = <span class="keyword">new</span> <span class="keywordtype">double</span>[<a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>.Count];
<a name="l00291"></a>00291  }
<a name="l00292"></a>00292  
<a name="l00302"></a><a class="code" href="class_capir_box.html#acf9795ec4895ceddd340b3a2658fb1b6">00302</a>  <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="class_capir_box.html#acf9795ec4895ceddd340b3a2658fb1b6" title="Reads the Q map.">readQMap</a>(<span class="keywordtype">string</span> filename, <span class="keywordtype">int</span> npcType){
<a name="l00303"></a>00303   <a class="code" href="class_capir_box.html#ac75212f782182be095c00d7be9a8e613" title="Stores the Q values of the NPC types existing in the map.">QValues</a>.Add(<a class="code" href="class_capir_box.html#a44a69b45ec289a73d22fdbade4d086d0" title="Reads the policy file to initialize QValues.">readPolicyFile</a>(filename + <span class="stringliteral">&quot;.&quot;</span>+ <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a8edfe2fe182b13944091762397095f45">NPCTypeStr</a>[npcType] + <span class="stringliteral">&quot;.0.Ftn&quot;</span>));
<a name="l00304"></a>00304  }
<a name="l00305"></a>00305  
<a name="l00315"></a><a class="code" href="class_capir_box.html#aed1f3348e4d8fd8ccaf087e95d10e97a">00315</a>  <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_capir_box.html#aed1f3348e4d8fd8ccaf087e95d10e97a" title="For debugging purpose: Prints the first elements.">printFirstElements</a>(Dictionary&lt;VirtualState, int&gt; dict, <span class="keywordtype">int</span> numElements){
<a name="l00316"></a>00316   List&lt;VirtualState&gt; keys = <span class="keyword">new</span> List&lt;VirtualState&gt;(dict.Keys);
<a name="l00317"></a>00317   
<a name="l00318"></a>00318   <span class="keywordtype">int</span> i=0;
<a name="l00319"></a>00319   <span class="keywordflow">foreach</span> (<a class="code" href="class_virtual_state.html" title="Virtual state, extracted from the game State.">VirtualState</a> key <span class="keywordflow">in</span> keys){
<a name="l00320"></a>00320    <span class="keywordflow">if</span> (i &gt;= numElements)
<a name="l00321"></a>00321     <span class="keywordflow">break</span>;
<a name="l00322"></a>00322    UnityEngine.Debug.Log(<span class="stringliteral">&quot;Virtual State &quot;</span> + i +  <span class="stringliteral">&quot;: &quot;</span> + key.<a class="code" href="class_virtual_state.html#ac3e9e5fb25dd84c920591526d9b20299">ToString</a>());
<a name="l00323"></a>00323   }
<a name="l00324"></a>00324  }
<a name="l00325"></a>00325  
<a name="l00335"></a><a class="code" href="class_capir_box.html#a44a69b45ec289a73d22fdbade4d086d0">00335</a>  <span class="keyword">public</span> <span class="keywordtype">double</span>[,,] <a class="code" href="class_capir_box.html#a44a69b45ec289a73d22fdbade4d086d0" title="Reads the policy file to initialize QValues.">readPolicyFile</a>(<span class="keywordtype">string</span> filename){
<a name="l00336"></a>00336 
<a name="l00337"></a>00337   <span class="keywordtype">string</span> uncompressedStr = <a class="code" href="class_zlib_decompression.html" title="Compression-decompression class. Used to inflate compressed Ftn files.">ZlibDecompression</a>.<a class="code" href="class_zlib_decompression.html#a58cf79abf19a55cd0ee233afef8a74e0" title="Decompresses the specified file.">decompress</a>(filename);
<a name="l00338"></a>00338   <span class="keywordtype">string</span>[] strArray = uncompressedStr.Split(<span class="charliteral">&#39; &#39;</span>);
<a name="l00339"></a>00339  
<a name="l00340"></a>00340   <span class="comment">// 1. read number of virtual states</span>
<a name="l00341"></a>00341   <span class="keywordtype">int</span> numVirtualStates = <span class="keywordtype">int</span>.Parse(strArray[0]);
<a name="l00342"></a>00342   
<a name="l00343"></a>00343   <span class="keywordtype">double</span>[,,] result = <span class="keyword">new</span> <span class="keywordtype">double</span>[numVirtualStates, <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#ae177f3d0d47d5c2f28a7705c0527da09" title="The number of human actions.">NumAgentActions</a>, <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a255a97c1088b93c872d282fa0a42a401" title="The number of helper actions.">NumHelperActions</a>];
<a name="l00344"></a>00344   
<a name="l00345"></a>00345   <span class="keywordtype">int</span> i = 1;
<a name="l00346"></a>00346   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j &lt;numVirtualStates; j++){
<a name="l00347"></a>00347    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#ae177f3d0d47d5c2f28a7705c0527da09" title="The number of human actions.">NumAgentActions</a>; k++){
<a name="l00348"></a>00348     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l=0; l&lt;<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a255a97c1088b93c872d282fa0a42a401" title="The number of helper actions.">NumHelperActions</a>; l++){
<a name="l00349"></a>00349      result[j,k,l] = <span class="keywordtype">double</span>.Parse(strArray[i]);
<a name="l00350"></a>00350      i++;
<a name="l00351"></a>00351     } 
<a name="l00352"></a>00352    }
<a name="l00353"></a>00353   }
<a name="l00354"></a>00354   
<a name="l00355"></a>00355   <span class="keywordflow">return</span> result;
<a name="l00356"></a>00356  }
<a name="l00357"></a>00357  
<a name="l00367"></a><a class="code" href="class_capir_box.html#a7f74ee8c67d0629785aeb4c059b25e59">00367</a>  <span class="keyword">public</span> Dictionary&lt;VirtualState, int&gt; <a class="code" href="class_capir_box.html#a7f74ee8c67d0629785aeb4c059b25e59" title="Deprecated! Generates the state map.">generateStateMap</a>(<span class="keywordtype">int</span> npcType){
<a name="l00368"></a>00368   <span class="comment">//UnityEngine.Debug.Log(&quot;generateStateMap&quot;);</span>
<a name="l00369"></a>00369   <a class="code" href="class_virtual_state.html" title="Virtual state, extracted from the game State.">VirtualState</a> state;
<a name="l00370"></a>00370   Dictionary&lt;VirtualState, int&gt; result = <span class="keyword">new</span> Dictionary&lt;VirtualState, int&gt;();
<a name="l00371"></a>00371   
<a name="l00372"></a>00372   <span class="keywordtype">int</span> sizeMonster = <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#aac56943a097efc7cf0a02cf8e067c877">numProperties</a>[npcType];
<a name="l00373"></a>00373   <span class="comment">//state = new VirtualState(sizeMonster);</span>
<a name="l00374"></a>00374   <span class="comment">// stateIndex 0 is termState, no need to store.</span>
<a name="l00375"></a>00375   <span class="keywordtype">int</span> stateIndex = 1;
<a name="l00376"></a>00376   
<a name="l00377"></a>00377   <span class="comment">// 1. construct a state</span>
<a name="l00378"></a>00378   <span class="comment">// TODO: may need to change to ySize first, xSize next, also the coordinates is i, ySize - j -1</span>
<a name="l00379"></a>00379   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p1x = 1; p1x &lt; <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a40dbdb86b9c460c7632dbac951cf2a32" title="The map width.">xSize</a>-1; p1x++){
<a name="l00380"></a>00380    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p1y = 1; p1y &lt; <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a44cad0d7dcfde1abd20f923c0f1661ba" title="The map height.">ySize</a>-1; p1y++){
<a name="l00381"></a>00381     <span class="keywordflow">if</span> (<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a4b208d1f9c0aa26723036d75058035be" title="The map layout.">map</a>[p1x,<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a44cad0d7dcfde1abd20f923c0f1661ba" title="The map height.">ySize</a> - p1y -1] != <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a4a6e415e1dedf46c975c51527f6c76ba">Wall</a>){
<a name="l00382"></a>00382      
<a name="l00383"></a>00383      
<a name="l00384"></a>00384      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p2x = 1; p2x &lt; <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a40dbdb86b9c460c7632dbac951cf2a32" title="The map width.">xSize</a>-1; p2x++){
<a name="l00385"></a>00385       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> p2y = 1; p2y &lt; <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a44cad0d7dcfde1abd20f923c0f1661ba" title="The map height.">ySize</a>-1; p2y++){
<a name="l00386"></a>00386        <span class="keywordflow">if</span> (<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a4b208d1f9c0aa26723036d75058035be" title="The map layout.">map</a>[p2x,<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a44cad0d7dcfde1abd20f923c0f1661ba" title="The map height.">ySize</a> - p2y-1] != <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a4a6e415e1dedf46c975c51527f6c76ba">Wall</a>){
<a name="l00387"></a>00387         
<a name="l00388"></a>00388         
<a name="l00389"></a>00389         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> mx = 1; mx &lt; <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a40dbdb86b9c460c7632dbac951cf2a32" title="The map width.">xSize</a>-1; mx++){
<a name="l00390"></a>00390          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> my = 1; my &lt; <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a44cad0d7dcfde1abd20f923c0f1661ba" title="The map height.">ySize</a>-1; my++){
<a name="l00391"></a>00391   
<a name="l00392"></a>00392           <span class="keywordflow">if</span> (<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a4b208d1f9c0aa26723036d75058035be" title="The map layout.">map</a>[mx,<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a44cad0d7dcfde1abd20f923c0f1661ba" title="The map height.">ySize</a> - my-1] != <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a4a6e415e1dedf46c975c51527f6c76ba">Wall</a>){
<a name="l00393"></a>00393            
<a name="l00394"></a>00394            state = <span class="keyword">new</span> <a class="code" href="class_virtual_state.html" title="Virtual state, extracted from the game State.">VirtualState</a>(sizeMonster);
<a name="l00395"></a>00395            
<a name="l00396"></a>00396            state.<a class="code" href="class_virtual_state.html#a89f09f7bea638e2a5f135db2e844adbf" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[0,0] = p1x;
<a name="l00397"></a>00397            state.<a class="code" href="class_virtual_state.html#a89f09f7bea638e2a5f135db2e844adbf" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[0,1] = p1y;
<a name="l00398"></a>00398            state.<a class="code" href="class_virtual_state.html#a89f09f7bea638e2a5f135db2e844adbf" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,0] = p2x;
<a name="l00399"></a>00399            state.<a class="code" href="class_virtual_state.html#a89f09f7bea638e2a5f135db2e844adbf" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,1] = p2y;
<a name="l00400"></a>00400            
<a name="l00401"></a>00401            state.<a class="code" href="class_virtual_state.html#a586aad6223afae0dac95fe5afacc7acf" title="The properties of the NPC.">monsterProperty</a>[0] = mx;
<a name="l00402"></a>00402            state.<a class="code" href="class_virtual_state.html#a586aad6223afae0dac95fe5afacc7acf" title="The properties of the NPC.">monsterProperty</a>[1] = my;
<a name="l00403"></a>00403            
<a name="l00404"></a>00404            <span class="comment">// if NPC is ghost, there is HP.</span>
<a name="l00405"></a>00405            <span class="keywordflow">if</span> (npcType == <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a9adae103b4e7ce4675e033f07efdff5d">GhostType</a>){
<a name="l00406"></a>00406             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> hp=0; hp&lt;= <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af428bbb428c8822bdb298608240c4149" title="Gets or sets the ghost max HP.">ghostMaxHP</a>; hp++){
<a name="l00407"></a>00407              state.<a class="code" href="class_virtual_state.html#a586aad6223afae0dac95fe5afacc7acf" title="The properties of the NPC.">monsterProperty</a>[2] = hp;
<a name="l00408"></a>00408              <span class="keywordflow">try</span>{
<a name="l00409"></a>00409               result.Add(state, stateIndex);
<a name="l00410"></a>00410 <span class="comment">//              if (stateIndex &lt;= 10)</span>
<a name="l00411"></a>00411 <span class="comment">//               UnityEngine.Debug.Log(&quot;Virtual State &quot; + stateIndex +  </span>
<a name="l00412"></a>00412 <span class="comment">//                &quot;: &quot; + state.ToString());</span>
<a name="l00413"></a>00413               stateIndex++;
<a name="l00414"></a>00414              }
<a name="l00415"></a>00415              <span class="keywordflow">catch</span>
<a name="l00416"></a>00416              {
<a name="l00417"></a>00417               UnityEngine.Debug.Log(<span class="stringliteral">&quot;Duplicated Virtual State &quot;</span> + 
<a name="l00418"></a>00418                stateIndex + <span class="stringliteral">&quot;: &quot;</span> + state.<a class="code" href="class_virtual_state.html#ac3e9e5fb25dd84c920591526d9b20299">ToString</a>());
<a name="l00419"></a>00419              }
<a name="l00420"></a>00420             }
<a name="l00421"></a>00421            
<a name="l00422"></a>00422            }
<a name="l00423"></a>00423            <span class="comment">// Otherwise, no additional property</span>
<a name="l00424"></a>00424            <span class="keywordflow">else</span>{
<a name="l00425"></a>00425             
<a name="l00426"></a>00426             <span class="keywordflow">try</span>{
<a name="l00427"></a>00427              result.Add(state, stateIndex);
<a name="l00428"></a>00428 <span class="comment">//             if (stateIndex &lt;= 10)</span>
<a name="l00429"></a>00429 <span class="comment">//               UnityEngine.Debug.Log(&quot;Virtual State &quot; + stateIndex +  </span>
<a name="l00430"></a>00430 <span class="comment">//                &quot;: &quot; + state.ToString());</span>
<a name="l00431"></a>00431              stateIndex++;
<a name="l00432"></a>00432             }
<a name="l00433"></a>00433             <span class="keywordflow">catch</span>
<a name="l00434"></a>00434             {
<a name="l00435"></a>00435              UnityEngine.Debug.Log(<span class="stringliteral">&quot;Duplicated Virtual State &quot;</span> + 
<a name="l00436"></a>00436               stateIndex + <span class="stringliteral">&quot;: &quot;</span> + state.<a class="code" href="class_virtual_state.html#ac3e9e5fb25dd84c920591526d9b20299">ToString</a>());
<a name="l00437"></a>00437             }
<a name="l00438"></a>00438             
<a name="l00439"></a>00439            }
<a name="l00440"></a>00440           }
<a name="l00441"></a>00441          } 
<a name="l00442"></a>00442         }   
<a name="l00443"></a>00443        }
<a name="l00444"></a>00444       } 
<a name="l00445"></a>00445      }   
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447    } 
<a name="l00448"></a>00448   }
<a name="l00449"></a>00449   UnityEngine.Debug.Log(<span class="stringliteral">&quot;generate state map for &quot;</span>+<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a8edfe2fe182b13944091762397095f45">NPCTypeStr</a>[npcType]+
<a name="l00450"></a>00450    <span class="stringliteral">&quot;, num Virtual States =&quot;</span>+ stateIndex);
<a name="l00451"></a>00451   
<a name="l00452"></a>00452   <span class="keywordflow">return</span> result;
<a name="l00453"></a>00453   
<a name="l00454"></a>00454  }
<a name="l00455"></a>00455  
<a name="l00473"></a><a class="code" href="class_capir_box.html#a9fc2163d4042042c211b7abab8e12517">00473</a>  <span class="keyword">public</span> Dictionary&lt;VirtualState, int&gt; <a class="code" href="class_capir_box.html#a9fc2163d4042042c211b7abab8e12517" title="Deprecated! Reads the state map from file.">readStateMapping</a>(<span class="keywordtype">string</span> filename){
<a name="l00474"></a>00474   
<a name="l00475"></a>00475   <span class="comment">//UnityEngine.Debug.Log(&quot;readStateMapping from &quot;+filename);</span>
<a name="l00476"></a>00476   <span class="keywordtype">string</span> uncompressedStr = <a class="code" href="class_zlib_decompression.html" title="Compression-decompression class. Used to inflate compressed Ftn files.">ZlibDecompression</a>.<a class="code" href="class_zlib_decompression.html#a58cf79abf19a55cd0ee233afef8a74e0" title="Decompresses the specified file.">decompress</a>(filename);
<a name="l00477"></a>00477   
<a name="l00478"></a>00478   <span class="keywordtype">string</span>[] strArray = uncompressedStr.Split(<span class="charliteral">&#39; &#39;</span>);
<a name="l00479"></a>00479   
<a name="l00480"></a>00480   Dictionary&lt;VirtualState, int&gt; result = <span class="keyword">new</span> Dictionary&lt;VirtualState, int&gt;();
<a name="l00481"></a>00481   
<a name="l00482"></a>00482   <span class="comment">//int xSize = parentScript.levelData.xSize;</span>
<a name="l00483"></a>00483   <span class="comment">//int ySize = parentScript.levelData.ySize;</span>
<a name="l00484"></a>00484   
<a name="l00485"></a>00485   <span class="comment">// 1. read number of virtual states</span>
<a name="l00486"></a>00486   <span class="keywordtype">int</span> numVirtualStates = <span class="keywordtype">int</span>.Parse(strArray[0]);
<a name="l00487"></a>00487   UnityEngine.Debug.Log(<span class="stringliteral">&quot;readStateMapping from &quot;</span>+filename+<span class="stringliteral">&quot;, num Virtual States =&quot;</span>+ numVirtualStates);
<a name="l00488"></a>00488   
<a name="l00489"></a>00489   
<a name="l00490"></a>00490   <a class="code" href="class_virtual_state.html" title="Virtual state, extracted from the game State.">VirtualState</a> state; <span class="comment">// = new VirtualState();</span>
<a name="l00491"></a>00491   <span class="comment">//state.monsterProperty.</span>
<a name="l00492"></a>00492   <span class="keywordtype">int</span> sizeMonster = <span class="keywordtype">int</span>.Parse(strArray[3]) - 2; <span class="comment">// exclude seesAgent and seesHelper</span>
<a name="l00493"></a>00493   
<a name="l00494"></a>00494   <span class="keywordtype">int</span> sizePerState = <span class="keywordtype">int</span>.Parse(strArray[1]) + <span class="keywordtype">int</span>.Parse(strArray[2]) 
<a name="l00495"></a>00495    + <span class="keywordtype">int</span>.Parse(strArray[3]) + <span class="keywordtype">int</span>.Parse(strArray[4]);
<a name="l00496"></a>00496   
<a name="l00497"></a>00497   <span class="keywordtype">int</span> offset;
<a name="l00498"></a>00498   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numVirtualStates; i++){
<a name="l00499"></a>00499    state = <span class="keyword">new</span> <a class="code" href="class_virtual_state.html" title="Virtual state, extracted from the game State.">VirtualState</a>(sizeMonster);
<a name="l00500"></a>00500    offset = 4 + i*sizePerState;
<a name="l00501"></a>00501    <span class="comment">// a. agent and helper</span>
<a name="l00502"></a>00502    <span class="comment">// exclude the first element, being the region id</span>
<a name="l00503"></a>00503    state.<a class="code" href="class_virtual_state.html#a89f09f7bea638e2a5f135db2e844adbf" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[0,0] = <span class="keywordtype">int</span>.Parse(strArray[offset + 2]);
<a name="l00504"></a>00504    state.<a class="code" href="class_virtual_state.html#a89f09f7bea638e2a5f135db2e844adbf" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[0,1] = <span class="keywordtype">int</span>.Parse(strArray[offset + 3]);
<a name="l00505"></a>00505    state.<a class="code" href="class_virtual_state.html#a89f09f7bea638e2a5f135db2e844adbf" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,0] = <span class="keywordtype">int</span>.Parse(strArray[offset + 5]);
<a name="l00506"></a>00506    state.<a class="code" href="class_virtual_state.html#a89f09f7bea638e2a5f135db2e844adbf" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,1] = <span class="keywordtype">int</span>.Parse(strArray[offset + 6]);
<a name="l00507"></a>00507    
<a name="l00508"></a>00508    <span class="comment">// b. NPC, exclude seesAgent and seesHelper because we are dealing with no abstraction here.</span>
<a name="l00509"></a>00509    offset = offset + 7;
<a name="l00510"></a>00510    state.<a class="code" href="class_virtual_state.html#a586aad6223afae0dac95fe5afacc7acf" title="The properties of the NPC.">monsterProperty</a>[0] = <span class="keywordtype">int</span>.Parse(strArray[offset]);
<a name="l00511"></a>00511    state.<a class="code" href="class_virtual_state.html#a586aad6223afae0dac95fe5afacc7acf" title="The properties of the NPC.">monsterProperty</a>[1] = <span class="keywordtype">int</span>.Parse(strArray[offset + 1]);
<a name="l00512"></a>00512    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=4; j &lt; sizeMonster + 2; j++){
<a name="l00513"></a>00513     state.<a class="code" href="class_virtual_state.html#a586aad6223afae0dac95fe5afacc7acf" title="The properties of the NPC.">monsterProperty</a>[j-2] = <span class="keywordtype">int</span>.Parse(strArray[offset + j]);
<a name="l00514"></a>00514    }
<a name="l00515"></a>00515    
<a name="l00516"></a>00516    <span class="comment">// c. I&#39;m not dealing with specialLocation here.</span>
<a name="l00517"></a>00517    <span class="comment">// d. Add into result</span>
<a name="l00518"></a>00518    <span class="keywordflow">try</span>{
<a name="l00519"></a>00519     result.Add(state, i);
<a name="l00520"></a>00520    }
<a name="l00521"></a>00521    <span class="keywordflow">catch</span>
<a name="l00522"></a>00522    {
<a name="l00523"></a>00523     UnityEngine.Debug.Log(<span class="stringliteral">&quot;Duplicated Virtual State &quot;</span> + i + <span class="stringliteral">&quot;: &quot;</span> + state.<a class="code" href="class_virtual_state.html#ac3e9e5fb25dd84c920591526d9b20299">ToString</a>());
<a name="l00524"></a>00524    }
<a name="l00525"></a>00525   }
<a name="l00526"></a>00526   
<a name="l00527"></a>00527   <span class="keywordflow">return</span> result;
<a name="l00528"></a>00528  }
<a name="l00529"></a>00529  
<a name="l00530"></a>00530  
<a name="l00531"></a>00531 <span class="comment">// public int realToVirtual(State state, int npcIndex){</span>
<a name="l00532"></a>00532 <span class="comment">//  </span>
<a name="l00533"></a>00533 <span class="comment">//  int stateMapIndex = existingNPCTypes[npcTypes[npcIndex]];</span>
<a name="l00534"></a>00534 <span class="comment">//  </span>
<a name="l00535"></a>00535 <span class="comment">//  // 1. construct state</span>
<a name="l00536"></a>00536 <span class="comment">//  VirtualState vState = new VirtualState(state.mazeProperties[npcIndex].Count - 1);</span>
<a name="l00537"></a>00537 <span class="comment">//  </span>
<a name="l00538"></a>00538 <span class="comment">//  vState.playerProperties = state.playerProperties;</span>
<a name="l00539"></a>00539 <span class="comment">//  </span>
<a name="l00540"></a>00540 <span class="comment">//  // exclude the first property in maze, because it is the NPCType.</span>
<a name="l00541"></a>00541 <span class="comment">//  for (int i=0; i&lt;state.mazeProperties[npcIndex].Count - 1; i++){</span>
<a name="l00542"></a>00542 <span class="comment">//   vState.monsterProperty[i] = state.mazeProperties[npcIndex][i+1];</span>
<a name="l00543"></a>00543 <span class="comment">//  }</span>
<a name="l00544"></a>00544 <span class="comment">//  </span>
<a name="l00545"></a>00545 <span class="comment">//  int result;</span>
<a name="l00546"></a>00546 <span class="comment">//  if (StateMaps[stateMapIndex].TryGetValue(vState, out result)){</span>
<a name="l00547"></a>00547 <span class="comment">//   return result;</span>
<a name="l00548"></a>00548 <span class="comment">//  }</span>
<a name="l00549"></a>00549 <span class="comment">//  else {</span>
<a name="l00550"></a>00550 <span class="comment">//   //Debug.Log(&quot;state not found: &quot;+ vState.ToString());</span>
<a name="l00551"></a>00551 <span class="comment">//   return 0;</span>
<a name="l00552"></a>00552 <span class="comment">//  }</span>
<a name="l00553"></a>00553 <span class="comment">// }</span>
<a name="l00554"></a>00554  
<a name="l00567"></a><a class="code" href="class_capir_box.html#a6d8923fe80fdcc8df0db36ed7cec649b">00567</a>  <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code" href="class_capir_box.html#a6d8923fe80fdcc8df0db36ed7cec649b" title="Return the integer representation of virtualState of NPC indexed at npcIndex.">realToVirtualFunction</a>(<a class="code" href="class_state.html" title="State class. Stores the game state.">State</a> state, <span class="keywordtype">int</span> npcIndex){
<a name="l00568"></a>00568   
<a name="l00569"></a>00569   <span class="keywordtype">int</span> npcType = <a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>[npcIndex];
<a name="l00570"></a>00570   
<a name="l00571"></a>00571   <span class="comment">// 1. get the freeSpaceIndex of coords.</span>
<a name="l00572"></a>00572   <span class="keywordtype">int</span> X1 = <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#ad997e08485b387710d79429958d9c361" title="The free grid nodes.">gridNodeLabel</a>[state.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[0,0], 
<a name="l00573"></a>00573    state.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[0,1]];
<a name="l00574"></a>00574   <span class="keywordtype">int</span> X2 = <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#ad997e08485b387710d79429958d9c361" title="The free grid nodes.">gridNodeLabel</a>[state.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,0], 
<a name="l00575"></a>00575    state.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,1]];
<a name="l00576"></a>00576   <span class="keywordtype">int</span> X3 = <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#ad997e08485b387710d79429958d9c361" title="The free grid nodes.">gridNodeLabel</a>[state.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>[npcIndex][1], 
<a name="l00577"></a>00577    state.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>[npcIndex][2]];
<a name="l00578"></a>00578   
<a name="l00579"></a>00579   <span class="comment">// num free grids</span>
<a name="l00580"></a>00580   <span class="keywordtype">int</span> NF = <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a7db1e901049831916fc6223adc06fc7e" title="The number of accessible locations, i.e. free grid nodes.">numAccessibleLocs</a>;
<a name="l00581"></a>00581   <span class="keywordtype">int</span> result = (X1 * NF + X2)*NF + X3;
<a name="l00582"></a>00582   
<a name="l00583"></a>00583   <span class="comment">// if it is ghost, there is HP</span>
<a name="l00584"></a>00584   <span class="keywordflow">if</span> (npcType == <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a9adae103b4e7ce4675e033f07efdff5d">GhostType</a>){
<a name="l00585"></a>00585    result = result * (<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af428bbb428c8822bdb298608240c4149" title="Gets or sets the ghost max HP.">ghostMaxHP</a>+1) + state.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>[npcIndex][3];
<a name="l00586"></a>00586   }
<a name="l00587"></a>00587   
<a name="l00588"></a>00588   <span class="keywordflow">return</span> result+1;
<a name="l00589"></a>00589  }
<a name="l00590"></a>00590  
<a name="l00600"></a><a class="code" href="class_capir_box.html#a657ff1868d19bd2c2e4831acd3b818d9">00600</a>  <span class="keyword">public</span> <span class="keywordtype">int</span> <a class="code" href="class_capir_box.html#a657ff1868d19bd2c2e4831acd3b818d9" title="Gets the best helper action.">getBestHelperAction</a>(){ <span class="comment">//(State state, int agentAction, double[] belief){</span>
<a name="l00601"></a>00601   
<a name="l00602"></a>00602   <span class="comment">// 1. compute condProbAct</span>
<a name="l00603"></a>00603   <span class="keywordtype">double</span>[,] condProbAct;
<a name="l00604"></a>00604   
<a name="l00605"></a>00605   <a class="code" href="class_capir_box.html#a7cfd807309eaed85e1af9eabeab25f5f" title="Gets the action model of the human-controlled character.">getActionModel</a>(<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af810f5d3a2e6f0493b34ffe7a3502462" title="Current state of the level.">state</a>, out condProbAct);
<a name="l00606"></a>00606   
<a name="l00607"></a>00607   <span class="comment">// 2. update belief</span>
<a name="l00608"></a>00608   <a class="code" href="class_capir_box.html#a050c18dbf5ffb2bcc332938fb7532d5d" title="Belief Update.">beliefUpdate</a>(<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af810f5d3a2e6f0493b34ffe7a3502462" title="Current state of the level.">state</a>, <a class="code" href="class_capir_box.html#aa730c780f4f5972e3e4bb4475b5e770f" title="The human-controlled character.">agent</a>.<a class="code" href="class_agent_script.html#a8fbf23f10298e4cddf44dc74a83909a8" title="The current action of human character.">action</a>, <a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c" title="The belief on human&amp;#39;s intention.">belief</a>, condProbAct);
<a name="l00609"></a>00609   
<a name="l00610"></a>00610   <span class="keywordtype">int</span> bestAct = (int)<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#aef02639df439fdb189ac5ae824fcbe67" title="Movement action names. The human/assistant/NPCs have the option not to move.">actions</a>.unchanged;
<a name="l00611"></a>00611   <span class="keywordtype">double</span> bestQValue = <a class="code" href="class_capir_box.html#a52ccb0faac10b436d45087a2003714d6" title="Computes the total Q value.">totalQValue</a>(<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af810f5d3a2e6f0493b34ffe7a3502462" title="Current state of the level.">state</a>, <a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c" title="The belief on human&amp;#39;s intention.">belief</a>, <a class="code" href="class_capir_box.html#aa730c780f4f5972e3e4bb4475b5e770f" title="The human-controlled character.">agent</a>.<a class="code" href="class_agent_script.html#a8fbf23f10298e4cddf44dc74a83909a8" title="The current action of human character.">action</a>, bestAct);
<a name="l00612"></a>00612   
<a name="l00613"></a>00613   <span class="keywordtype">double</span> qValue;
<a name="l00614"></a>00614    
<a name="l00615"></a>00615   List&lt;int&gt; validActions = <span class="keyword">new</span> List&lt;int&gt;();
<a name="l00616"></a>00616   
<a name="l00617"></a>00617   <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#a779162d6b579af7e998a7d92775a7078" title="The level layout, storing the map configuration and the starting positions of characters. See MapData for further information.">levelData</a>.<a class="code" href="class_map_data.html#a9c344e5041868e8dc627885f612d31d1" title="Returns valid actions at point xCoord , yCoord .">getValidActions</a>(validActions, 
<a name="l00618"></a>00618    <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af810f5d3a2e6f0493b34ffe7a3502462" title="Current state of the level.">state</a>.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,0], 
<a name="l00619"></a>00619    <a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af810f5d3a2e6f0493b34ffe7a3502462" title="Current state of the level.">state</a>.<a class="code" href="class_state.html#a23a4eb779b23b02a6e0e4c5829965dc8" title="Two players, each having only (x,y) coordinates. 0: human, 1: helper.">playerProperties</a>[1,1]);
<a name="l00620"></a>00620  
<a name="l00621"></a>00621   <span class="comment">//string debugMsg = &quot;&quot;;</span>
<a name="l00622"></a>00622   <span class="keywordflow">foreach</span>(<span class="keywordtype">int</span> hAct <span class="keywordflow">in</span> validActions){
<a name="l00623"></a>00623    
<a name="l00624"></a>00624    <span class="comment">// get the total Q value for each helper action</span>
<a name="l00625"></a>00625    qValue = <a class="code" href="class_capir_box.html#a52ccb0faac10b436d45087a2003714d6" title="Computes the total Q value.">totalQValue</a>(<a class="code" href="class_capir_box.html#aa2bf361670c77533c6a4a6bcc32f4c07" title="The MainCSharp object that uses CapirBox for query.">parentScript</a>.<a class="code" href="class_main_c_sharp.html#af810f5d3a2e6f0493b34ffe7a3502462" title="Current state of the level.">state</a>, <a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c" title="The belief on human&amp;#39;s intention.">belief</a>, <a class="code" href="class_capir_box.html#aa730c780f4f5972e3e4bb4475b5e770f" title="The human-controlled character.">agent</a>.<a class="code" href="class_agent_script.html#a8fbf23f10298e4cddf44dc74a83909a8" title="The current action of human character.">action</a>, hAct);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627    <span class="comment">//debugMsg += qValue.ToString() + &quot;, &quot;;</span>
<a name="l00628"></a>00628    <span class="comment">// Then get the max</span>
<a name="l00629"></a>00629    <span class="keywordflow">if</span> (qValue &gt; bestQValue){ 
<a name="l00630"></a>00630     bestQValue = qValue;
<a name="l00631"></a>00631     bestAct = hAct;
<a name="l00632"></a>00632    }
<a name="l00633"></a>00633   }
<a name="l00634"></a>00634   <span class="comment">//UnityEngine.Debug.Log(&quot;QValues: &quot;+debugMsg);</span>
<a name="l00635"></a>00635   <span class="comment">// Then return the action</span>
<a name="l00636"></a>00636   <span class="keywordflow">return</span> bestAct;
<a name="l00637"></a>00637  }
<a name="l00638"></a>00638  
<a name="l00657"></a><a class="code" href="class_capir_box.html#a52ccb0faac10b436d45087a2003714d6">00657</a>  <span class="keyword">private</span> <span class="keywordtype">double</span> <a class="code" href="class_capir_box.html#a52ccb0faac10b436d45087a2003714d6" title="Computes the total Q value.">totalQValue</a>(<a class="code" href="class_state.html" title="State class. Stores the game state.">State</a> s, <span class="keywordtype">double</span>[] <a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c" title="The belief on human&amp;#39;s intention.">belief</a>, <span class="keywordtype">int</span> agentAction, <span class="keywordtype">int</span> hAct){
<a name="l00658"></a>00658   <span class="keywordtype">double</span> result = 0.0;
<a name="l00659"></a>00659   
<a name="l00660"></a>00660   <span class="keywordtype">int</span> virtualState;
<a name="l00661"></a>00661   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt; belief.Length; i++){
<a name="l00662"></a>00662    <span class="keywordflow">if</span> (s.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>[i][1] &gt;=0 &amp;&amp; belief[i] &gt; 0){
<a name="l00663"></a>00663     virtualState = <a class="code" href="class_capir_box.html#a6d8923fe80fdcc8df0db36ed7cec649b" title="Return the integer representation of virtualState of NPC indexed at npcIndex.">realToVirtualFunction</a>(s, i);
<a name="l00664"></a>00664     result += belief[i] * <a class="code" href="class_capir_box.html#ac75212f782182be095c00d7be9a8e613" title="Stores the Q values of the NPC types existing in the map.">QValues</a>[<a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>[<a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>[i]]]
<a name="l00665"></a>00665           [virtualState, agentAction, hAct];
<a name="l00666"></a>00666    }
<a name="l00667"></a>00667   }
<a name="l00668"></a>00668   
<a name="l00669"></a>00669   <span class="keywordflow">return</span> result;
<a name="l00670"></a>00670  }
<a name="l00671"></a>00671  
<a name="l00681"></a><a class="code" href="class_capir_box.html#a7cfd807309eaed85e1af9eabeab25f5f">00681</a>  <span class="keyword">private</span> <span class="keywordtype">void</span> <a class="code" href="class_capir_box.html#a7cfd807309eaed85e1af9eabeab25f5f" title="Gets the action model of the human-controlled character.">getActionModel</a>(<a class="code" href="class_state.html" title="State class. Stores the game state.">State</a> currState, out <span class="keywordtype">double</span>[,] condProbAct) {
<a name="l00682"></a>00682   <span class="comment">// Caller already checked for terminality of the state</span>
<a name="l00683"></a>00683  
<a name="l00684"></a>00684   <span class="comment">// sumProb stores the summation of all probabilities involved to use for normalization</span>
<a name="l00685"></a>00685   <span class="keywordtype">double</span> maxQValue, tempQValue;
<a name="l00686"></a>00686   maxQValue = -1;
<a name="l00687"></a>00687   <span class="comment">//double sumProb;</span>
<a name="l00688"></a>00688  
<a name="l00689"></a>00689   <span class="comment">// counters, act = human act, ca = compound act</span>
<a name="l00690"></a>00690   <span class="keywordtype">int</span> i, act, tempVState;
<a name="l00691"></a>00691  
<a name="l00692"></a>00692   <span class="comment">// 5. Construct 2D matrix p( a | i ) with x dimension as worldNum, y dimension as actNum</span>
<a name="l00693"></a>00693   <span class="comment">// this part is used to infer the world given human&#39;s action.</span>
<a name="l00694"></a>00694   condProbAct = <span class="keyword">new</span> <span class="keywordtype">double</span>[currState.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>.Count, <a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#ae177f3d0d47d5c2f28a7705c0527da09" title="The number of human actions.">NumAgentActions</a>];
<a name="l00695"></a>00695   <a class="code" href="class_utilities.html" title="Utilities class that has utility routines.">Utilities</a>.PopulateMatrix&lt;<span class="keywordtype">double</span>&gt;(condProbAct, 0.0);
<a name="l00696"></a>00696   
<a name="l00697"></a>00697   <span class="keywordflow">for</span> (i = 0; i &lt; currState.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>.Count; i++) {
<a name="l00698"></a>00698  
<a name="l00699"></a>00699    <span class="comment">// isOptimalAct.resize(0);</span>
<a name="l00700"></a>00700    <span class="comment">// if this is not terminal state</span>
<a name="l00701"></a>00701    <span class="comment">//if (currState.mazeProperties[i][1] &gt;= 0) {</span>
<a name="l00702"></a>00702    <span class="keywordflow">if</span> (currState.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>[i][1] &gt;= 0) { 
<a name="l00703"></a>00703     <span class="comment">//tempVState = realToVirtual(currState, i);</span>
<a name="l00704"></a>00704     tempVState = <a class="code" href="class_capir_box.html#a6d8923fe80fdcc8df0db36ed7cec649b" title="Return the integer representation of virtualState of NPC indexed at npcIndex.">realToVirtualFunction</a>(currState, i);
<a name="l00705"></a>00705     
<a name="l00706"></a>00706     <span class="comment">//sumProb = 0;</span>
<a name="l00707"></a>00707     <span class="comment">// act = human act</span>
<a name="l00708"></a>00708     <span class="keywordflow">for</span> (act = (<span class="keywordtype">int</span>)<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#aef02639df439fdb189ac5ae824fcbe67" title="Movement action names. The human/assistant/NPCs have the option not to move.">actions</a>.unchanged; act &lt;= (<span class="keywordtype">int</span>)<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#aef02639df439fdb189ac5ae824fcbe67" title="Movement action names. The human/assistant/NPCs have the option not to move.">actions</a>.shoot; act++) { 
<a name="l00709"></a>00709      
<a name="l00710"></a>00710      <span class="comment">// 1. get max value of (*(mazeWorld-&gt;mazes[i])-&gt;collabQFn)[tempVState][compAct] where act is part of</span>
<a name="l00711"></a>00711      
<a name="l00712"></a>00712      maxQValue = <a class="code" href="class_capir_box.html#ac75212f782182be095c00d7be9a8e613" title="Stores the Q values of the NPC types existing in the map.">QValues</a>[<a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>[<a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>[i]]][tempVState,act,0];
<a name="l00713"></a>00713      
<a name="l00714"></a>00714      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> partnerAct = (<span class="keywordtype">int</span>)<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#aef02639df439fdb189ac5ae824fcbe67" title="Movement action names. The human/assistant/NPCs have the option not to move.">actions</a>.unchanged; 
<a name="l00715"></a>00715       partnerAct &lt;= (<span class="keywordtype">int</span>)<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#aef02639df439fdb189ac5ae824fcbe67" title="Movement action names. The human/assistant/NPCs have the option not to move.">actions</a>.north; partnerAct++) {
<a name="l00716"></a>00716 
<a name="l00717"></a>00717       tempQValue = <a class="code" href="class_capir_box.html#ac75212f782182be095c00d7be9a8e613" title="Stores the Q values of the NPC types existing in the map.">QValues</a>[<a class="code" href="class_capir_box.html#ac145ee4a0c6c31efcb7076f89746266a" title="This array stores the index of the Q function for each NPC type.">existingNPCTypes</a>[<a class="code" href="class_capir_box.html#afd8d01b7817a03ddfb0ce7bc9c2d5afb" title="The npc types, i.e. Sheep or Ghost.">npcTypes</a>[i]]][tempVState, act, partnerAct];
<a name="l00718"></a>00718       
<a name="l00719"></a>00719       <span class="keywordflow">if</span> (maxQValue &lt; tempQValue)
<a name="l00720"></a>00720        maxQValue = tempQValue;
<a name="l00721"></a>00721      }
<a name="l00722"></a>00722      condProbAct[i, act] = Math.Exp(<a class="code" href="class_game_constants.html" title="This class defines the constants used in SheepSavior game.">GameConstants</a>.<a class="code" href="class_game_constants.html#a9ce2404ee982309c8ccff1e044450985" title="This multiplicative term increases the difference between Q values, because Q values tend to be close...">ActionMult</a> * maxQValue);
<a name="l00723"></a>00723      <span class="comment">//condProbAct[i, act] = Math.Exp(maxQValue);</span>
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725    } <span class="comment">// if termState</span>
<a name="l00726"></a>00726    <span class="comment">// if this is terminal state, condProbAct[i][act] are all 0</span>
<a name="l00727"></a>00727   } <span class="comment">// for long i</span>
<a name="l00728"></a>00728  }
<a name="l00729"></a>00729  
<a name="l00745"></a><a class="code" href="class_capir_box.html#a050c18dbf5ffb2bcc332938fb7532d5d">00745</a>  <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_capir_box.html#a050c18dbf5ffb2bcc332938fb7532d5d" title="Belief Update.">beliefUpdate</a>(<a class="code" href="class_state.html" title="State class. Stores the game state.">State</a> state, <span class="keywordtype">int</span> agentAction, <span class="keywordtype">double</span>[] <a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c" title="The belief on human&amp;#39;s intention.">belief</a>, <span class="keywordtype">double</span>[,] condProbAct){
<a name="l00746"></a>00746   
<a name="l00747"></a>00747   <span class="keywordtype">int</span> i, j;
<a name="l00748"></a>00748   <span class="keywordtype">int</span> numAliveWorlds = <a class="code" href="class_utilities.html" title="Utilities class that has utility routines.">Utilities</a>.NumDifference&lt;<span class="keywordtype">double</span>&gt;(<a class="code" href="class_capir_box.html#aac8f9eb727a05ba2fa0d0f054169445c" title="The belief on human&amp;#39;s intention.">belief</a>, 0.0);
<a name="l00749"></a>00749   
<a name="l00750"></a>00750   <span class="keywordflow">if</span> (numAliveWorlds &lt;= 1){
<a name="l00751"></a>00751    <a class="code" href="class_utilities.html" title="Utilities class that has utility routines.">Utilities</a>.<a class="code" href="class_utilities.html#ac34213597e830ec6effd6d34512826f4" title="Normalizes the distribution arr .">Normalize</a>(belief);
<a name="l00752"></a>00752    <span class="keywordflow">return</span>;
<a name="l00753"></a>00753   }
<a name="l00754"></a>00754   
<a name="l00755"></a>00755   <span class="comment">// 1. Target drift</span>
<a name="l00756"></a>00756   <span class="keywordtype">double</span>[] prevBelief;
<a name="l00757"></a>00757   prevBelief = (<span class="keywordtype">double</span>[]) belief.Clone();
<a name="l00758"></a>00758  
<a name="l00759"></a>00759   <span class="keywordflow">for</span> (i = 0; i &lt; belief.Length; i++) {
<a name="l00760"></a>00760    belief[i] = 0;
<a name="l00761"></a>00761    <span class="keywordflow">if</span> (prevBelief[i] &gt; 0){
<a name="l00762"></a>00762     <span class="keywordflow">for</span> (j = 0; j &lt; prevBelief.Length; j++) {
<a name="l00763"></a>00763      <span class="keywordflow">if</span> (j==i)
<a name="l00764"></a>00764       belief[i] += <a class="code" href="class_capir_box.html#a04cfc66fb085d1742c5e83a1fd6f4692" title="The preset human persistence.">agentPersistence</a> * prevBelief[j];
<a name="l00765"></a>00765      <span class="keywordflow">else</span> 
<a name="l00766"></a>00766       belief[i] += (1-<a class="code" href="class_capir_box.html#a04cfc66fb085d1742c5e83a1fd6f4692" title="The preset human persistence.">agentPersistence</a>) * prevBelief[j] / (numAliveWorlds-1);
<a name="l00767"></a>00767     }
<a name="l00768"></a>00768    }
<a name="l00769"></a>00769 <span class="comment">//   if (Utilities.DoubleEquals(belief[i], 0)){</span>
<a name="l00770"></a>00770 <span class="comment">//    int blah;</span>
<a name="l00771"></a>00771 <span class="comment">//    blah = 0;</span>
<a name="l00772"></a>00772 <span class="comment">//   }</span>
<a name="l00773"></a>00773   }
<a name="l00774"></a>00774   
<a name="l00775"></a>00775   <span class="comment">// 2. Bayesian inference</span>
<a name="l00776"></a>00776   <span class="keywordtype">double</span> sumProb = 0.0;
<a name="l00777"></a>00777   <a class="code" href="class_utilities.html" title="Utilities class that has utility routines.">Utilities</a>.<a class="code" href="class_utilities.html#ab266965a7d0e24f48872d6c822ae43f5" title="Normalizes the matrix arr  with respect to dimension dim .">NormalizeMatrix</a>(condProbAct, 0);
<a name="l00778"></a>00778   <span class="comment">//UnityEngine.Debug.Log(&quot;condProbAct: &quot;+Utilities.getMatrixStr(condProbAct));</span>
<a name="l00779"></a>00779   
<a name="l00780"></a>00780   <span class="keywordflow">for</span> (i = 0; i &lt; state.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>.Count; i++) {
<a name="l00781"></a>00781    <span class="comment">// 0: not terminal</span>
<a name="l00782"></a>00782    <span class="keywordflow">if</span> (state.<a class="code" href="class_state.html#ad463ed23c1243917cacda51e58fe02fb" title="List of NPC properties. At least 3 properties for mazeProperties[i]: type, coordX, coordY.">mazeProperties</a>[i][1] &gt;= 0){
<a name="l00783"></a>00783     <span class="comment">// update belief</span>
<a name="l00784"></a>00784     belief[i] *= condProbAct[i, agentAction];
<a name="l00785"></a>00785    }
<a name="l00786"></a>00786    <span class="keywordflow">else</span> belief[i] = 0;
<a name="l00787"></a>00787    sumProb += belief[i];
<a name="l00788"></a>00788   }
<a name="l00789"></a>00789  
<a name="l00790"></a>00790   <span class="keywordflow">for</span> (i = 0; i &lt; belief.Length ; i++) {
<a name="l00791"></a>00791    <span class="keywordflow">if</span> (sumProb &gt; 0)
<a name="l00792"></a>00792     belief[i] /= sumProb;
<a name="l00793"></a>00793    <span class="keywordflow">else</span>
<a name="l00794"></a>00794     belief[i] = 1.0 / belief.Length;
<a name="l00795"></a>00795   }
<a name="l00796"></a>00796   
<a name="l00797"></a>00797  }
<a name="l00798"></a>00798  
<a name="l00802"></a><a class="code" href="class_capir_box.html#a45ff7805f9ebf9b934c2d1ddee107586">00802</a>  <span class="keyword">public</span> <span class="keywordtype">void</span> <a class="code" href="class_capir_box.html#a45ff7805f9ebf9b934c2d1ddee107586" title="Does nothing.">Update</a>(){
<a name="l00803"></a>00803   
<a name="l00804"></a>00804  }
<a name="l00805"></a>00805 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="_capir_box_8cs.html">CapirBox.cs</a>      </li>
      <li class="footer">Generated on Thu Jun 21 2012 11:33:51 for UnityCAPIR by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Properties</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


</body>
</html>
